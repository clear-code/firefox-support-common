# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this
# file, You can obtain one at http://mozilla.org/MPL/2.0/.

Download-0: ファイルのダウンロード動作の検証

   :1: 事前準備

    - 前項に引き続いて検証するか、{%if use_meta_installer %}または以下の状態を整えておく。
        - 作成済みの `{{meta_installer_file_name}}*.exe` を検証用ユーザーとして実行し、カスタマイズ済みFirefoxのインストールを完了している。
        - 管理者権限を要求された場合は、`管理者`ユーザーで認証する。
    {% else %}再ログオン、インストーラの手動実行など、所定の手順でFirefoxのインストール及びカスタマイズを反映済みの状態とする。{% endif %}

Download-1: ダウンロードマネージャの利用の可否

    :1: 利用する（既定）

    - Firefoxを起動する。
    - テストケースリストのリンクから `https://www.mozilla.org/ja/firefox/windows/` を開く。
    - 「今すぐダウンロード」のボタン（リンク）をクリックする。
    - ファイルのダウンロードが開始され、保存方法を尋ねるダイアログが表示されるので、ダウンロードを開始する。
    - **確認**
        - ダウンロードの進行状況を示すポップアップが表示される。

    :2: 利用しない

    - Firefoxを起動する。
    - テストケースリストのリンクから `https://www.mozilla.org/ja/firefox/windows/` を開く。
    - 「今すぐダウンロード」のボタン（リンク）をクリックする。
    - ファイルのダウンロードが開始され、保存方法を尋ねるダイアログが表示されるので、ダウンロードを開始する。
    - **確認**
        - ダウンロードの進行状況を示すポップアップが表示されない。

Download-2: ファイルの既定のダウンロード先

    :4: 指定する：任意

    - 既定のダウンロード先（ユーザー配下の「ダウンロード」、または`{{download_dir}}`）を用意しておく。用意できない場合は、設定の参照先を `C:\` などの実在するパスに変更し、以下の説明も読み替える。
    - Firefoxを起動する。
    - テストケースリストのリンクから `https://www.mozilla.org/ja/firefox/windows/` を開く。
    - 「今すぐダウンロード」のボタン（リンク）をクリックする。
    - ファイルのダウンロードが開始され、保存方法を尋ねるダイアログが表示されるので、ファイルの保存操作をキャンセルする。
    - 再ダウンロードのリンクを右クリックし、メニューから「名前を付けてリンク先を保存」を選択する。
    - **確認**
        - ダウンロード先として `{{download_dir}}` または検証用に再設定した保存先が選択された状態でファイル選択ダイアログが開かれる。

    :5: 指定する：任意の場所に固定

    - 既定のダウンロード先（ユーザー配下の「ダウンロード」、または`{{download_dir}}`）を用意しておく。用意できない場合は、設定の参照先を `C:\` などの実在するパスに変更し、以下の説明も読み替える。
    - Firefoxを起動する。
    - テストケースリストのリンクから `https://www.mozilla.org/ja/firefox/windows/` を開く。
    - 「今すぐダウンロード」のボタン（リンク）をクリックする。
    - ファイルのダウンロードが開始され、保存方法を尋ねるダイアログが表示されるので、ファイルの保存操作をキャンセルする。
    - 再ダウンロードのリンクを右クリックし、メニューから「名前を付けてリンク先を保存」を選択する。
    - **確認**
        - ダウンロード先として `{{download_dir}}` または検証用に再設定した保存先が選択された状態でファイル選択ダイアログが開かれる。

    :2: 指定する：デスクトップ

    - Firefoxを起動する。
    - テストケースリストのリンクから `https://www.mozilla.org/ja/firefox/windows/` を開く。
    - 「今すぐダウンロード」のボタン（リンク）をクリックする。
    - ファイルのダウンロードが開始され、保存方法を尋ねるダイアログが表示されるので、ファイルの保存操作をキャンセルする。
    - 再ダウンロードのリンクを右クリックし、メニューから「名前を付けてリンク先を保存」を選択する。
    - **確認**
        - ダウンロード先として `{{download_dir}}` または検証用に再設定した保存先が選択された状態でファイル選択ダイアログが開かれる。

    :3: 指定しない（既定）

    - Firefoxを起動する。
    - テストケースリストのリンクから `https://www.mozilla.org/ja/firefox/windows/` を開く。
    - 「今すぐダウンロード」のボタン（リンク）をクリックする。
    - ファイルのダウンロードが開始され、保存方法を尋ねるダイアログが表示されるので、ファイルの保存操作をキャンセルする。
    - 再ダウンロードのリンクを右クリックし、メニューから「名前を付けてリンク先を保存」を選択する。
    - **確認**
        - ホームディレクトリ内の「ダウンロード」が選択された状態でファイル選択ダイアログが開かれる。

Download-3: ファイルのダウンロード先ディレクトリの制御

    :1: 全体で共通のディレクトリにダウンロードする

    - Firefoxを起動する。
    - テストケースリストのリンクから `https://www.mozilla.org/ja/firefox/windows/` を開く。
    - 「今すぐダウンロード」のボタン（リンク）をクリックする。
    - ファイルのダウンロードが開始され、保存方法を尋ねるダイアログが表示されるので、ファイルの保存操作をキャンセルする。
    - 再ダウンロードのリンクを右クリックし、メニューから「名前を付けてリンク先を保存」を選択する。
    - **確認**
        1. ダウンロード先として `{{download_dir}}` または検証用に再設定した保存先が選択された状態でファイル選択ダイアログが開かれる。
    - `subfolder` という名前でフォルダを作成し、そのフォルダを選択してダウンロードを開始する。
    - テストケースリストのリンクから `http://www.mozilla.org/` を開く。
    - Webページ中の任意のリンクを右クリックし、「名前を付けてリンク先を保存」を選択する。
    - **確認**
        1. ダウンロード先として `{{download_dir}}` または検証用に再設定した保存先内の「subfolder」が選択された状態でファイル選択ダイアログが開かれる。
    - 先ほどとは別のダウンロード先フォルダーを選択する。
    - テストケースリストのリンクから `https://www.mozilla.org/ja/firefox/windows/` を開く。
    - 「今すぐダウンロード」のボタン（リンク）をクリックする。
    - ファイルのダウンロードが開始され、保存方法を尋ねるダイアログが表示されるので、ファイルの保存操作をキャンセルする。
    - 再ダウンロードのリンクを右クリックし、メニューから「名前を付けてリンク先を保存」を選択する。
    - **確認**
        1. 「subfolder」ではなく、最後にファイルのダウンロード先として選択したフォルダが選択された状態でファイル選択ダイアログが開かれる。
    - テストケースリストのリンクから `https://www.mozilla.org/ja/firefox/windows/` を開く。
    - 「今すぐダウンロード」のボタン（リンク）をクリックする。
    - ファイルのダウンロードが開始され、保存方法を尋ねるダイアログが表示されるので、ファイルの保存を続行する。
    - **確認**
        1. 確認ダイアログが表示されず、 `{{download_dir}}` または検証用に再設定した保存先にファイルが保存される。

    :2: サイトごとにダウンロード先ディレクトリを保持する（既定）

    - Firefoxを起動する。
    - テストケースリストのリンクから `https://www.mozilla.org/ja/firefox/windows/` を開く。
    - 「今すぐダウンロード」のボタン（リンク）をクリックする。
    - ファイルのダウンロードが開始され、保存方法を尋ねるダイアログが表示されるので、ファイルの保存操作をキャンセルする。
    - 再ダウンロードのリンクを右クリックし、メニューから「名前を付けてリンク先を保存」を選択する。
    - **確認**
        1. ダウンロード先として `{{download_dir}}` または検証用に再設定した保存先が選択された状態でファイル選択ダイアログが開かれる。
    - `subfolder` という名前でフォルダを作成し、そのフォルダを選択してダウンロードを開始する。
    - テストケースリストのリンクから `http://www.mozilla.org/` を開く。
    - Webページ中の任意のリンクを右クリックし、「名前を付けてリンク先を保存」を選択する。
    - 先ほどとは別のダウンロード先フォルダーを選択する。
    - テストケースリストのリンクから `https://www.mozilla.org/ja/firefox/windows/` を開く。
    - 「今すぐダウンロード」のボタン（リンク）をクリックする。
    - ファイルのダウンロードが開始され、保存方法を尋ねるダイアログが表示されるので、ファイルの保存操作をキャンセルする。
    - 再ダウンロードのリンクを右クリックし、メニューから「名前を付けてリンク先を保存」を選択する。
    - **確認**
        1. ダウンロード先として `{{download_dir}}` または検証用に再設定した保存先内の「subfolder」が選択された状態でファイル選択ダイアログが開かれる。
    - テストケースリストのリンクから `https://www.mozilla.org/ja/firefox/windows/` を開く。
    - 「今すぐダウンロード」のボタン（リンク）をクリックする。
    - ファイルのダウンロードが開始され、保存方法を尋ねるダイアログが表示されるので、ファイルの保存を続行する。
    - **確認**
        1. 確認ダイアログが表示されず、 `{{download_dir}}` または検証用に再設定した保存先にファイルが保存される。

    :4: ダウンロード先を固定せず、常にユーザに選択させる

    {% if DownloadExeFile %}
    - Firefoxを起動する。
    - テストケースリストのリンクから `https://www.mozilla.org/ja/firefox/windows/` を開く。
    - 「今すぐダウンロード」のボタン（リンク）をクリックする。
    - ファイルのダウンロードが開始され、保存方法を尋ねるダイアログが表示されるので、「ファイルを保存」をクリックする。
    - **確認**
        - ダウンロード先ディレクトリを選択するダイアログが開かれる。
    {% endif %}
    - `about:policies` を開く。
    - 「有効」配下の各設定値を確認する。
    - **確認**
        - `PromptForDownloadLocation` の値が `true` である。


Download-4: 安全なWebサイトからの安全でないダウンロード、制限コンテンツからのダウンロードの自動ブロック

    :1: ブロックする（既定）

    - Firefoxを起動する。
    - テストケースリストのリンクから `https://piro.sakura.ne.jp/test.html` を開く。
    - 「HTTPでのアクセス（PDF）」のリンクを右クリックし、「名前を付けてリンク先を保存」を選択する。
    - ファイルのダウンロード先ディレクトリを選択する。
    - **確認**
        - ダウンローマネージャ上で、セキュリティ上の理由によりダウンロードが停止された旨の警告が表示される。

    :2: ブロックしない

    - Firefoxを起動する。
    - テストケースリストのリンクから `https://piro.sakura.ne.jp/test.html` を開く。
    - 「HTTPでのアクセス（PDF）」のリンクを右クリックし、「名前を付けてリンク先を保存」を選択する。
    - ファイルのダウンロード先ディレクトリを選択する。
    - **確認**
        - 警告無しでダウンロードが完了する。


Download-5: Firefox 98以前からの移行時における、ファイルの種類ごとの取り扱い

    :1: 「毎回選択する」を既定の挙動に戻す（既定）

    - Firefoxを終了する。
    - ユーザープロファイルフォルダーを開き、ファイルをすべて削除する。
    - テストケースの「handlers.json」をユーザープロファイルフォルダーにコピーする。
    - Firefoxを起動する。
    - パネルメニューから「設定」を開く。
    - 設定画面の「一般」を開く。
    - **確認**
        - 「ファイルとプログラム」配下の「プログラム」に「毎回確認する」が選択されていない項目がある。

    :2: 何もしない

    - Firefoxを終了する。
    - ユーザープロファイルフォルダーを開き、ファイルをすべて削除する。
    - テストケースの「handlers.json」をユーザープロファイルフォルダーにコピーする。
    - Firefoxを起動する。
    - パネルメニューから「設定」を開く。
    - 設定画面の「一般」を開く。
    - **確認**
        - 「ファイルとプログラム」配下の「プログラム」のすべての項目で「毎回確認する」が選択されている。


Download-6: 未知の種類のファイルのダウンロード時の既定の挙動

    :1: ファイルを保存する（既定）

    - Firefoxを起動する。
    - テストケースリストのリンクから `https://piro.sakura.ne.jp/test.html` を開く。
    - 「application/octet-streamで送出されるPDF（拡張子:.bin）」のリンクをクリックする。
    - **確認**
        - 動作選択のダイアログが表示されず、ファイルのダウンロードが開始される。

    :2: ファイルを開くか保存するかを確認する

    - Firefoxを起動する。
    - テストケースリストのリンクから `https://piro.sakura.ne.jp/test.html` を開く。
    - 「application/octet-streamで送出されるPDF（拡張子:.bin）」のリンクをクリックする。
    - **確認**
        - プログラムで開くかファイルを保存するかの動作選択のダイアログが表示される。

