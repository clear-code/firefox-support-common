# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this
# file, You can obtain one at http://mozilla.org/MPL/2.0/.

External-0: 外部アプリケーションとの連係動作の検証

   :1: 事前準備

    - 前項に引き続いて検証するか、{%if use_meta_installer %}または以下の状態を整えておく。
        - 作成済みの `{{meta_installer_file_name}}*.exe` を検証用ユーザーとして実行し、カスタマイズ済みFirefoxのインストールを完了している。
        - 管理者権限を要求された場合は、`管理者`ユーザーで認証する。
    {% else %}再ログオン、インストーラの手動実行など、所定の手順でFirefoxのインストール及びカスタマイズを反映済みの状態とする。{% endif %}

External-1: ファイルをダウンロードして直接外部アプリケーションで開く時の挙動

    :1: ファイルを読み込み専用で開き、アプリケーション終了後に一時ファイルを削除する（既定）

    {% if Download_6_1 %}
    - policies.jsonまたはMCD用設定ファイルを編集し、`browser.download.always_ask_before_handling_new_types` を未設定にする。
    {% endif %}
    - エクスプローラを起動して、{% if External_2_1 %}アドレスバーに `%temp%` と入力し、システムのテンポラリフォルダを開く{% else %}ファイルの既定のダウンロード先フォルダーを開く{% endif %}。
    - ファイルを更新日時順で並べ替えて、新しいファイルが出現したら分かるようにしておく。
    - この検証手順書自体のファイルをWebサーバにアップロードするか、`odt sample` のようなキーワードでWebを検索するなどして、外部アプリケーションで開く必要があるファイルのダウンロード用リンクを用意しておく。
    - Firefoxを起動する。
    - パネルメニューから「設定」を開く。
    - 設定画面の「一般」を開く。
    - 「ファイルとプログラム」→「プログラム」→「他のファイルはFirefoxでどのように扱いますか？」で「ファイルを開くか保存するかを確認する」が選択されていなければ選択する。
    - 外部アプリケーションで開く必要があるファイルへのリンクをクリックする。
    - 「次のファイルを開こうとしています」のダイアログが表示されたら、起動する外部アプリケーションを選択して「OK」をクリックする。
    - {% if External_2_1 %}テンポラリフォルダ{% else %}`{{ download_dir }}`または検証用に再設定した保存先{% endif %}の内容を確認する。
    - **確認**
        - ダウンロードしたファイルが{% if External_2_1 %}テンポラリフォルダ{% else %}`{{ download_dir }}`または検証用に再設定した保存先{% endif %}に保存されている。
        {% if Download_5_2 %}
        - テンポラリファイルのプロパティにおいて、「読み取り専用」がチェックありもしくは半チェック（四角形の塗りつぶし、または半透明のチェックマーク）の状態である。
        {% endif %}
    - 外部アプリケーションを終了しFirefoxも終了して、{% if External_2_1 %}テンポラリフォルダ{% else %}`{{ download_dir }}`または検証用に再設定した保存先{% endif %}の内容を確認する。
    - **確認**
        {% if External_2_1 %}
        - ダウンロードしたファイルがテンポラリフォルダから消えている。
        {% else %}
        - ダウンロードしたファイルが`{{ download_dir }}`または検証用に再設定した保存先に残っている。
        {% endif %}
    - 設定画面の「一般」→「ファイルとプログラム」→「プログラム」→「他のファイルはFirefoxでどのように扱いますか？」の選択状態を変更した場合、元に戻す。
    {% if Download_6_1 %}
    - policies.jsonまたはMCD用設定ファイルを編集し、`browser.download.always_ask_before_handling_new_types` を設定済みの状態に戻す。
    {% endif %}

    :2: ファイルを読み書き可能で開き、アプリケーション終了後に一時ファイルを削除しない

    {% if Download_6_1 %}
    - policies.jsonまたはMCD用設定ファイルを編集し、`browser.download.always_ask_before_handling_new_types` を未設定にする。
    {% endif %}
    - エクスプローラを起動して、{% if External_2_1 %}アドレスバーに `%temp%` と入力し、システムのテンポラリフォルダを開く{% else %}ファイルの既定のダウンロード先フォルダーを開く{% endif %}。
    - ファイルを更新日時順で並べ替えて、新しいファイルが出現したら分かるようにしておく。
    - この検証手順書自体のファイルをWebサーバにアップロードするか、`odt sample` のようなキーワードでWebを検索するなどして、外部アプリケーションで開く必要があるファイルのダウンロード用リンクを用意しておく。
    - Firefoxを起動する。
    - パネルメニューから「設定」を開く。
    - 設定画面の「一般」を開く。
    - 「ファイルとプログラム」→「プログラム」→「他のファイルはFirefoxでどのように扱いますか？」で「ファイルを開くか保存するかを確認する」が選択されていなければ選択する。
    - 外部アプリケーションで開く必要があるファイルへのリンクをクリックする。
    - 「次のファイルを開こうとしています」のダイアログが表示されたら、起動する外部アプリケーションを選択して「OK」をクリックする。
    - {% if External_2_1 %}テンポラリフォルダ{% else %}`{{ download_dir }}`または検証用に再設定した保存先{% endif %}の内容を確認する。
    - **確認**
        - ダウンロードしたファイルが{% if External_2_1 %}テンポラリフォルダ{% else %}`{{ download_dir }}`または検証用に再設定した保存先{% endif %}に保存されている。
        - テンポラリファイルのプロパティにおいて、「読み取り専用」がチェック無しの状態である。
    - 外部アプリケーションを終了しFirefoxも終了して、{% if External_2_1 %}テンポラリフォルダ{% else %}`{{ download_dir }}`または検証用に再設定した保存先{% endif %}の内容を確認する。
    - **確認**
        - ダウンロードしたファイルが{% if External_2_1 %}テンポラリフォルダ{% else %}`{{ download_dir }}`または検証用に再設定した保存先{% endif %}に残っている。
    - 設定画面の「一般」→「ファイルとプログラム」→「プログラム」→「他のファイルはFirefoxでどのように扱いますか？」の選択状態を変更した場合、元に戻す。
    {% if Download_6_1 %}
    - policies.jsonまたはMCD用設定ファイルを編集し、`browser.download.always_ask_before_handling_new_types` を設定済みの状態に戻す。
    {% endif %}

External-2: 外部アプリケーションで開くためにダウンロードされた一時ファイルの保存先

    :1: システムの一時ファイル置き場

    - エクスプローラを起動して、ファイルの既定のダウンロード先フォルダーを開く。
    - ファイルを更新日時順で並べ替えて、新しいファイルが出現したら分かるようにしておく。
      {%if Download_6_1 %}
    - ポリシー設定から Download-6-1 の `browser.download.always_ask_before_handling_new_types` の定義を削除し、未知の種類のファイルのダウンロードを強制しない状態にしておく。
      {% endif %}
    - Firefoxを起動する。
      {% if Download_6_1 %}
    - パネルメニューから「設定」を開く。
    - 設定画面の「一般」を開く。
    - 「ファイルとプログラム」→「プログラム」→「他のファイルはFirefoxでどのように扱いますか？」で「ファイルを開くか保存するかを確認する」を選択する。
      {% endif %}
    - テストケースリストのリンクから `https://piro.sakura.ne.jp/test.html`を開く。
    - 外部アプリケーションで開く必要があるファイル(「設定」→「一般]→「プログラム」に登録されていない拡張子であること)へのリンクをクリックする。
      例えば「application/octet-streamで送出されるPDF（拡張子:.bin）」を使用する。
    - 「次のファイルを開こうとしています」のダイアログが表示されたら、起動する外部アプリケーションを選択して「OK」をクリックする。
    - **確認**
        - ファイルの既定のダウンロード先フォルダー内に一時ファイルがダウンロードされていない。
      {% if Download_6_1 %}
    - 設定画面の「一般」→「ファイルとプログラム」→「プログラム」→「他のファイルはFirefoxでどのように扱いますか？」を「ファイルを保存する」に戻す。
    - ポリシー設定から一時的に削除した `browser.download.always_ask_before_handling_new_types` の定義を元に戻す。
      {% endif %}

    :2: ダウンロード先フォルダー（既定）

    - エクスプローラを起動して、ファイルの既定のダウンロード先フォルダーを開く。
    - ファイルを更新日時順で並べ替えて、新しいファイルが出現したら分かるようにしておく。
      {%if Download_6_1 %}
    - ポリシー設定から Download-6-1 の `browser.download.always_ask_before_handling_new_types` の定義を削除し、未知の種類のファイルのダウンロードを強制しない状態にしておく。
      {% endif %}
    - Firefoxを起動する。
      {% if Download_6_1 %}
    - パネルメニューから「設定」を開く。
    - 設定画面の「一般」を開く。
    - 「ファイルとプログラム」→「プログラム」→「他のファイルはFirefoxでどのように扱いますか？」で「ファイルを開くか保存するかを確認する」を選択する。
      {% endif %}
    - テストケースリストのリンクから `https://piro.sakura.ne.jp/test.html`を開く。
    - 外部アプリケーションで開く必要があるファイル(「設定」→「一般]→「プログラム」に登録されていない拡張子であること)へのリンクをクリックする。
      例えば「application/octet-streamで送出されるPDF（拡張子:.bin）」を使用する。
    - 「次のファイルを開こうとしています」のダイアログが表示されたら、起動する外部アプリケーションを選択して「OK」をクリックする。
    - **確認**
        - ファイルの既定のダウンロード先フォルダー内に一時ファイルがダウンロードされている。
      {% if Download_6_1 %}
    - 設定画面の「一般」→「ファイルとプログラム」→「プログラム」→「他のファイルはFirefoxでどのように扱いますか？」を「ファイルを保存する」に戻す。
    - ポリシー設定から一時的に削除した `browser.download.always_ask_before_handling_new_types` の定義を元に戻す。
      {% endif %}
